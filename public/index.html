<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Truyện Chữ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* CSS Nâng cấp Giao diện */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f6; /* Màu nền nhẹ nhàng */
        }
        .container {
            max-width: 1000px; /* Tăng chiều rộng tối đa */
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff; /* Nền trắng cho nội dung */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Thêm bóng đổ nhẹ */
            border-radius: 8px;
        }

        /* Tiêu đề ứng dụng */
        #app-title {
            cursor: pointer;
            color: #007bff;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* Giao diện đọc chương */
        #chapter-content-container {
            padding: 20px 0;
        }
        #chapter-content {
            white-space: pre-wrap; /* Quan trọng để giữ định dạng xuống dòng của nội dung */
            font-size: 18px; /* Cỡ chữ lớn hơn */
            line-height: 1.8; /* Giãn dòng thoải mái */
            margin-top: 20px;
            color: #333; /* Màu chữ dễ đọc */
        }
        #chapter-title {
            font-size: 28px;
            color: #007bff; /* Màu xanh nổi bật */
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Nút */
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .novel-card {
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .novel-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div class="container mt-4">
        <header class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <h2 id="app-title" onclick="showNovelList()">Web Truyện Chữ</h2>
            <div id="auth-controls">
                </div>
        </header>

        <div id="main-content">
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api'
            : '/api';
        
        const mainContent = document.getElementById('main-content');
        const authControls = document.getElementById('auth-controls');
        let currentUser = null;

        // =======================================================
        // CÁC HÀM TIỆN ÍCH
        // =======================================================

        function getToken() {
            return localStorage.getItem('token');
        }

        function saveToken(token) {
            localStorage.setItem('token', token);
        }

        function removeToken() {
            localStorage.removeItem('token');
        }

        function parseToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        function updateAuthControls() {
            const token = getToken();
            if (token) {
                currentUser = parseToken(token);
                if (currentUser) {
                    authControls.innerHTML = `
                        <span class="me-3 fw-bold text-success"><i class="fas fa-user-circle"></i> ${currentUser.name}</span>
                        <button class="btn btn-sm btn-danger" onclick="logout()">Đăng Xuất</button>
                    `;
                } else {
                    logout(); // Token không hợp lệ, xóa token
                }
            } else {
                currentUser = null;
                authControls.innerHTML = `
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="showLoginForm()">Đăng Nhập</button>
                    <button class="btn btn-sm btn-primary" onclick="showRegisterForm()">Đăng Ký</button>
                `;
            }
        }
        
        async function checkTokenOnLoad() {
             const token = getToken();
             if (token) {
                 currentUser = parseToken(token);
                 // Thêm kiểm tra hết hạn (đơn giản)
                 if (currentUser && currentUser.exp * 1000 > Date.now()) {
                    updateAuthControls();
                 } else {
                    removeToken();
                    currentUser = null;
                    updateAuthControls();
                 }
             }
        }

        // =======================================================
        // XỬ LÝ AUTHENTICATION
        // =======================================================
        
        function logout() {
            removeToken();
            currentUser = null;
            updateAuthControls();
            showNovelList();
        }

        function showLoginForm() {
            mainContent.innerHTML = `
                <h3>Đăng Nhập</h3>
                <form id="login-form" class="mt-4">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="login-email" required value="admin@truyen.com">
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Mật khẩu</label>
                        <input type="password" class="form-control" id="login-password" required value="123456">
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Đăng Nhập</button>
                    <div id="login-message" class="mt-3 text-danger"></div>
                </form>
            `;

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const messageDiv = document.getElementById('login-message');
                messageDiv.textContent = '';

                try {
                    const response = await fetch(`${API_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        saveToken(data.token);
                        updateAuthControls();
                        showNovelList();
                    } else {
                        messageDiv.textContent = data.message || 'Đăng nhập thất bại.';
                    }
                } catch (error) {
                    messageDiv.textContent = 'Lỗi kết nối server.';
                }
            });
        }

        function showRegisterForm() {
            mainContent.innerHTML = `
                <h3>Đăng Ký Tài Khoản</h3>
                <form id="register-form" class="mt-4">
                    <div class="mb-3">
                        <label for="register-name" class="form-label">Tên người dùng</label>
                        <input type="text" class="form-control" id="register-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="register-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="register-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="register-password" class="form-label">Mật khẩu (ít nhất 6 ký tự)</label>
                        <input type="password" class="form-control" id="register-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> Đăng Ký</button>
                    <div id="register-message" class="mt-3 text-danger"></div>
                </form>
            `;

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const messageDiv = document.getElementById('register-message');
                messageDiv.textContent = '';

                try {
                    const response = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        messageDiv.className = 'mt-3 text-success';
                        messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message || 'Đăng ký thành công! Vui lòng đăng nhập.'}`;
                        // Tự động chuyển về form đăng nhập sau 2s
                        setTimeout(showLoginForm, 2000); 
                    } else {
                        messageDiv.className = 'mt-3 text-danger';
                        // Hiển thị lỗi từ validation (nếu có)
                        if (data.errors && data.errors.length > 0) {
                            messageDiv.textContent = data.errors[0].msg;
                        } else {
                            messageDiv.textContent = data.message || 'Đăng ký thất bại.';
                        }
                    }
                } catch (error) {
                    messageDiv.className = 'mt-3 text-danger';
                    messageDiv.textContent = 'Lỗi kết nối server.';
                }
            });
        }

        // =======================================================
        // XỬ LÝ NOVELS (TRUYỆN)
        // =======================================================

        async function fetchNovels() {
            const response = await fetch(`${API_URL}/novels`);
            return response.json();
        }

        async function fetchNovelDetails(novelId) {
            const response = await fetch(`${API_URL}/novels/${novelId}`);
            return response.json();
        }

        async function fetchNovelChapters(novelId) {
            const response = await fetch(`${API_URL}/novels/${novelId}/chapters`);
            return response.json();
        }

        function showNovelList() {
            let addNovelButton = '';
            if (currentUser) {
                addNovelButton = `
                    <button class="btn btn-success mb-3" onclick="showAddNovelForm()"><i class="fas fa-plus"></i> Thêm Truyện Mới</button>
                `;
            }

            mainContent.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Danh Sách Truyện</h3>
                    ${addNovelButton}
                </div>
                <div id="novel-list" class="row">
                    <p class="text-center text-muted">Đang tải truyện...</p>
                </div>
            `;

            fetchNovels().then(novels => {
                const novelListDiv = document.getElementById('novel-list');
                novelListDiv.innerHTML = '';
                if (novels.length === 0) {
                     novelListDiv.innerHTML = '<p class="text-center text-muted">Chưa có truyện nào.</p>';
                } else {
                    novels.forEach(novel => {
                        novelListDiv.innerHTML += `
                            <div class="col-md-6 col-lg-4">
                                <div class="card novel-card">
                                    <div class="card-body">
                                        <h5 class="card-title text-primary" style="cursor: pointer;" onclick="showNovelDetails(${novel.id})">${novel.title}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-pen-nib"></i> Tác giả: ${novel.author_name}</h6>
                                        <p class="card-text text-truncate">${novel.description}</p>
                                        <button class="btn btn-sm btn-outline-info" onclick="showNovelDetails(${novel.id})">Đọc Truyện</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            }).catch(() => {
                document.getElementById('novel-list').innerHTML = '<p class="text-center text-danger">Lỗi khi tải danh sách truyện.</p>';
            });
        }

        async function showNovelDetails(novelId) {
            try {
                const novel = await fetchNovelDetails(novelId);
                const chapters = await fetchNovelChapters(novelId);
                
                let controls = '';
                if (currentUser && (currentUser.id === novel.user_id || currentUser.role === 'admin')) {
                    controls = `
                        <div class="my-3 d-flex justify-content-end">
                            <button class="btn btn-sm btn-info me-2" onclick="showAddChapterForm(${novel.id})"><i class="fas fa-plus-square"></i> Thêm Chương</button>
                            <button class="btn btn-sm btn-warning me-2" onclick="showEditNovelForm(${novel.id})"><i class="fas fa-edit"></i> Sửa Truyện</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNovel(${novel.id})"><i class="fas fa-trash-alt"></i> Xóa Truyện</button>
                        </div>
                    `;
                }

                let chapterListHtml = chapters.length === 0 
                    ? '<p class="text-center text-muted">Truyện chưa có chương nào.</p>'
                    : '<ul class="list-group list-group-flush">';

                chapters.forEach((chapter, index) => {
                    chapterListHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="chapter-link text-primary" style="cursor: pointer;" onclick="showChapter(${chapter.id})">
                                <i class="fas fa-file-alt me-2"></i> Chương ${index + 1}: ${chapter.title}
                            </span>
                            ${currentUser && (currentUser.id === novel.user_id || currentUser.role === 'admin') ? 
                                `<div>
                                    <button class="btn btn-sm btn-outline-warning me-2" onclick="showEditChapterForm(${chapter.id}, ${novel.id})"><i class="fas fa-pen"></i> Sửa</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteChapter(${chapter.id}, ${novel.id})"><i class="fas fa-times"></i> Xóa</button>
                                </div>`
                                : ''}
                        </li>
                    `;
                });
                if (chapters.length > 0) chapterListHtml += '</ul>';


                mainContent.innerHTML = `
                    <button class="btn btn-secondary btn-sm mb-3" onclick="showNovelList()"><i class="fas fa-arrow-left"></i> Quay lại</button>
                    <h2 class="text-center text-success">${novel.title}</h2>
                    <p class="text-center text-muted">Tác giả: ${novel.author_name}</p>
                    <div class="alert alert-light border p-3">
                        <p class="fw-bold">Tóm tắt:</p>
                        <p>${novel.description}</p>
                    </div>
                    ${controls}
                    <h4><i class="fas fa-list-ol"></i> Mục Lục Chương:</h4>
                    ${chapterListHtml}
                `;

            } catch (error) {
                mainContent.innerHTML = `<p class="text-danger">Lỗi: Không tìm thấy truyện hoặc lỗi server.</p>`;
            }
        }
        
        // Form CRUD cho Novel... (Tương tự code cũ, không thay đổi)
        function showAddNovelForm() {
            // ... (Code hiện form Thêm Truyện) ...
            mainContent.innerHTML = `
                <h3>Thêm Truyện Mới</h3>
                <form id="add-novel-form" class="mt-4">
                    <div class="mb-3">
                        <label for="novel-title" class="form-label">Tên Truyện</label>
                        <input type="text" class="form-control" id="novel-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="novel-description" class="form-label">Tóm Tắt</label>
                        <textarea class="form-control" id="novel-description" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Lưu Truyện</button>
                    <button type="button" class="btn btn-secondary" onclick="showNovelList()">Hủy</button>
                    <div id="novel-message" class="mt-3"></div>
                </form>
            `;

            document.getElementById('add-novel-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('novel-title').value;
                const description = document.getElementById('novel-description').value;
                const messageDiv = document.getElementById('novel-message');
                messageDiv.textContent = '';

                try {
                    const response = await fetch(`${API_URL}/novels`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` 
                        },
                        body: JSON.stringify({ title, description })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        messageDiv.className = 'mt-3 text-success';
                        messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message || 'Thêm truyện thành công!'}`;
                        setTimeout(showNovelDetails.bind(null, data.novelId), 1500);
                    } else if (response.status === 401 || response.status === 403) {
                        messageDiv.className = 'mt-3 text-danger';
                        messageDiv.textContent = 'Bạn cần đăng nhập để thêm truyện.';
                    } else {
                        messageDiv.className = 'mt-3 text-danger';
                        messageDiv.textContent = data.message || 'Lỗi khi thêm truyện.';
                    }
                } catch (error) {
                    messageDiv.className = 'mt-3 text-danger';
                    messageDiv.textContent = 'Lỗi kết nối server.';
                }
            });
        }
        
        async function showEditNovelForm(novelId) {
             const novel = await fetchNovelDetails(novelId);
             if (!novel) return;

             mainContent.innerHTML = `
                 <h3>Sửa Truyện: ${novel.title}</h3>
                 <form id="edit-novel-form" class="mt-4">
                     <div class="mb-3">
                         <label for="novel-title" class="form-label">Tên Truyện</label>
                         <input type="text" class="form-control" id="novel-title" value="${novel.title}" required>
                     </div>
                     <div class="mb-3">
                         <label for="novel-description" class="form-label">Tóm Tắt</label>
                         <textarea class="form-control" id="novel-description" rows="5" required>${novel.description}</textarea>
                     </div>
                     <button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt"></i> Cập Nhật</button>
                     <button type="button" class="btn btn-secondary" onclick="showNovelDetails(${novelId})">Hủy</button>
                     <div id="novel-message" class="mt-3"></div>
                 </form>
             `;

             document.getElementById('edit-novel-form').addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const title = document.getElementById('novel-title').value;
                 const description = document.getElementById('novel-description').value;
                 const messageDiv = document.getElementById('novel-message');
                 messageDiv.textContent = '';

                 try {
                     const response = await fetch(`${API_URL}/novels/${novelId}`, {
                         method: 'PUT',
                         headers: { 
                             'Content-Type': 'application/json',
                             'Authorization': `Bearer ${getToken()}` 
                         },
                         body: JSON.stringify({ title, description })
                     });

                     const data = await response.json();

                     if (response.ok) {
                         messageDiv.className = 'mt-3 text-success';
                         messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message || 'Cập nhật truyện thành công!'}`;
                         setTimeout(showNovelDetails.bind(null, novelId), 1500);
                     } else if (response.status === 401 || response.status === 403) {
                         messageDiv.className = 'mt-3 text-danger';
                         messageDiv.textContent = 'Bạn không có quyền sửa truyện này.';
                     } else {
                         messageDiv.className = 'mt-3 text-danger';
                         messageDiv.textContent = data.message || 'Lỗi khi cập nhật truyện.';
                     }
                 } catch (error) {
                     messageDiv.className = 'mt-3 text-danger';
                     messageDiv.textContent = 'Lỗi kết nối server.';
                 }
             });
         }
        
        async function deleteNovel(novelId) {
             if (!confirm('Bạn có chắc chắn muốn XÓA truyện này và TẤT CẢ các chương của nó không?')) return;

             try {
                 const response = await fetch(`${API_URL}/novels/${novelId}`, {
                     method: 'DELETE',
                     headers: { 'Authorization': `Bearer ${getToken()}` }
                 });

                 const data = await response.json();

                 if (response.ok) {
                     alert('Xóa truyện thành công!');
                     showNovelList();
                 } else if (response.status === 401 || response.status === 403) {
                     alert('Bạn không có quyền xóa truyện này.');
                 } else {
                     alert(data.message || 'Lỗi khi xóa truyện.');
                 }
             } catch (error) {
                 alert('Lỗi kết nối server.');
             }
         }

        // =======================================================
        // XỬ LÝ CHAPTERS (CHƯƠNG)
        // =======================================================

        // Hàm Đã được Nâng cấp: Thêm logic chuyển chương
        async function showChapter(chapterId) {
            try {
                const response = await fetch(`${API_URL}/chapters/${chapterId}`);
                if (!response.ok) throw new Error('Không tìm thấy chương');

                const chapter = await response.json();
                const novel = await fetchNovelDetails(chapter.novel_id);
                const chapters = await fetchNovelChapters(chapter.novel_id); // Tải tất cả các chương

                // Tính toán chương trước/sau
                const chapterIndex = chapters.findIndex(c => c.id === chapterId);
                const prevChapter = chapterIndex > 0 ? chapters[chapterIndex - 1] : null;
                const nextChapter = chapterIndex < chapters.length - 1 ? chapters[chapterIndex + 1] : null;

                const chapterHtml = `
                    <div id="chapter-content-container">
                        <h1 id="chapter-title">${chapter.title}</h1>
                        <p class="text-center text-muted mb-4">Thuộc truyện: <span class="text-primary fw-bold" style="cursor: pointer;" onclick="showNovelDetails(${novel.id})">${novel.title}</span></p>
                        <div id="chapter-content">${chapter.content}</div>
                    </div>
                `;
                
                // Cập nhật phần navigation (Đã Nâng cấp)
                const navHtml = `
                    <div class="d-flex justify-content-between my-4">
                        <button class="btn btn-secondary" ${prevChapter ? '' : 'disabled'} onclick="showChapter(${prevChapter?.id})">
                            <i class="fas fa-arrow-left"></i> Chương Trước
                        </button>
                        <button class="btn btn-primary" onclick="showNovelDetails(${novel.id})">
                            <i class="fas fa-list"></i> Mục Lục
                        </button>
                        <button class="btn btn-secondary" ${nextChapter ? '' : 'disabled'} onclick="showChapter(${nextChapter?.id})">
                            Chương Tiếp <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `;
                
                mainContent.innerHTML = navHtml + chapterHtml + navHtml;

            } catch (error) {
                mainContent.innerHTML = `<p class="text-danger">Lỗi: Không tìm thấy chương hoặc lỗi server.</p>`;
            }
        }
        
        // Form CRUD cho Chapter... (Code tương tự, không thay đổi)
        function showAddChapterForm(novelId) {
            mainContent.innerHTML = `
                <h3>Thêm Chương Mới</h3>
                <form id="add-chapter-form" class="mt-4">
                    <div class="mb-3">
                        <label for="chapter-title" class="form-label">Tên Chương</label>
                        <input type="text" class="form-control" id="chapter-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-content" class="form-label">Nội Dung Chương</label>
                        <textarea class="form-control" id="chapter-content" rows="15" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Lưu Chương</button>
                    <button type="button" class="btn btn-secondary" onclick="showNovelDetails(${novelId})">Hủy</button>
                    <div id="chapter-message" class="mt-3"></div>
                </form>
            `;

            document.getElementById('add-chapter-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('chapter-title').value;
                const content = document.getElementById('chapter-content').value;
                const messageDiv = document.getElementById('chapter-message');
                messageDiv.textContent = '';

                try {
                    const response = await fetch(`${API_URL}/novels/${novelId}/chapters`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` 
                        },
                        body: JSON.stringify({ title, content })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        messageDiv.className = 'mt-3 text-success';
                        messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message || 'Thêm chương thành công!'}`;
                        setTimeout(showNovelDetails.bind(null, novelId), 1500);
                    } else if (response.status === 401 || response.status === 403) {
                        messageDiv.className = 'mt-3 text-danger';
                        messageDiv.textContent = 'Bạn không có quyền thêm chương cho truyện này.';
                    } else {
                        messageDiv.className = 'mt-3 text-danger';
                        messageDiv.textContent = data.message || 'Lỗi khi thêm chương.';
                    }
                } catch (error) {
                    messageDiv.className = 'mt-3 text-danger';
                    messageDiv.textContent = 'Lỗi kết nối server.';
                }
            });
        }
        
        async function showEditChapterForm(chapterId, novelId) {
            const response = await fetch(`${API_URL}/chapters/${chapterId}`);
            const chapter = await response.json();
            if (!chapter) return;

            mainContent.innerHTML = `
                <h3>Sửa Chương: ${chapter.title}</h3>
                <form id="edit-chapter-form" class="mt-4">
                    <div class="mb-3">
                        <label for="chapter-title" class="form-label">Tên Chương</label>
                        <input type="text" class="form-control" id="chapter-title" value="${chapter.title}" required>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-content" class="form-label">Nội Dung Chương</label>
                        <textarea class="form-control" id="chapter-content" rows="15" required>${chapter.content}</textarea>
                    </div>
                    <button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt"></i> Cập Nhật</button>
                    <button type="button" class="btn btn-secondary" onclick="showNovelDetails(${novelId})">Hủy</button>
                    <div id="chapter-message" class="mt-3"></div>
                </form>
            `;

            document.getElementById('edit-chapter-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('chapter-title').value;
                const content = document.getElementById('chapter-content').value;
                const messageDiv = document.getElementById('chapter-message');
                messageDiv.textContent = '';

                try {
                    const response = await fetch(`${API_URL}/chapters/${chapterId}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` 
                        },
                        body: JSON.stringify({ title, content })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        messageDiv.className = 'mt-3 text-success';
                        messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message || 'Cập nhật chương thành công!'}`;
                        setTimeout(showNovelDetails.bind(null, novelId), 1500);
                    } else if (response.status === 401 || response.status === 403) {
                        messageDiv.className = 'mt-3 text-danger';
                        messageDiv.textContent = 'Bạn không có quyền sửa chương này.';
                    } else {
                        messageDiv.className = 'mt-3 text-danger';
                        messageDiv.textContent = data.message || 'Lỗi khi cập nhật chương.';
                    }
                } catch (error) {
                    messageDiv.className = 'mt-3 text-danger';
                    messageDiv.textContent = 'Lỗi kết nối server.';
                }
            });
        }
        
        async function deleteChapter(chapterId, novelId) {
            if (!confirm('Bạn có chắc chắn muốn XÓA chương này không?')) return;

            try {
                const response = await fetch(`${API_URL}/chapters/${chapterId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Xóa chương thành công!');
                    showNovelDetails(novelId);
                } else if (response.status === 401 || response.status === 403) {
                    alert('Bạn không có quyền xóa chương này.');
                } else {
                    alert(data.message || 'Lỗi khi xóa chương.');
                }
            } catch (error) {
                alert('Lỗi kết nối server.');
            }
        }

        // =======================================================
        // KHỞI ĐỘNG ỨNG DỤNG
        // =======================================================

        checkTokenOnLoad();
        showNovelList();

    </script>
</body>
</html>